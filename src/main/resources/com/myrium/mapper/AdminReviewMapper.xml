<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.myrium.mapper.AdminReviewMapper">

<resultMap id="ReviewsummaryMap" type="com.myrium.domain.ReviewsummaryVO">
    <id property="productId" column="product_id"/>
    <result property="productName" column="product_name"/>
    <result property="reviewCount" column="review_count"/>
    <result property="avgRating" column="avg_rating"/>
    <result property="imageUrl" column="image_url"/>
    <result property="lastReviewDate" column="latest_review_date"/>
</resultMap>

<resultMap id="reviewDTOMap" type="com.myrium.domain.ReviewDTO">
    <id property="id" column="id"/>
    <result property="userId" column="user_id"/>
    <result property="productId" column="product_id"/>
    <result property="customerId" column="customer_id"/>
    <result property="reviewTitle" column="review_title"/>
    <result property="reviewContent" column="review_content"/>
    <result property="imageUrl" column="image_url"/>
    <result property="rating" column="rating"/>
    <result property="viewCount" column="view_count"/>
    <result property="reviewDate" column="review_date"/>
    <result property="isDeleted" column="is_deleted"/>
    <result property="createdAt" column="created_at"/>
    <result property="createdBy" column="created_by"/>
    
    <!-- join 컬럼 -->
    <result property="productName" column="product_name"/>
    <result property="summary" column="summary"/>
    <result property="commentCount" column="comment_count"/>
</resultMap>

<sql id="criteria">
  <trim prefix="AND (" suffix=")" prefixOverrides="OR">
    <foreach item="type" collection="cri.typeArr">
      <trim prefix="OR">
        <choose>
          <when test="type == 'P'.toString()">
            p.product_name LIKE '%' || #{cri.keyword} || '%'
          </when>
        </choose>
      </trim>
    </foreach>
  </trim>
</sql>

<select id="getPagedProductIds" resultMap="ReviewsummaryMap">
SELECT * FROM (
  SELECT
    p.id AS product_id,
    p.product_name,
    MAX(r.image_url) KEEP (DENSE_RANK FIRST ORDER BY r.review_date DESC) AS image_url,
    COUNT(r.id) AS review_count,
    AVG(r.rating) AS avg_rating,
    MAX(r.review_date) AS latest_review_date,
    ROW_NUMBER() OVER (ORDER BY MAX(r.review_date) DESC) rn
  FROM product p
  INNER JOIN review r ON r.product_id = p.id
  WHERE 1=1
      <if test="cri.keyword != null and cri.keyword != '' and cri.typeArr != null and cri.typeArr.length > 0">
        <include refid="criteria"/>
      </if>
    GROUP BY p.id, p.product_name
  )
  WHERE rn &gt; (#{cri.pageNum} - 1) * #{cri.amount}
    AND rn &lt;= #{cri.pageNum} * #{cri.amount}
</select>

<select id="getReviewsWithProducts" resultMap="reviewDTOMap">
  SELECT *
  FROM (
    SELECT 
      r.id,
      r.user_id,
      r.product_id,
      r.customer_id,
      r.review_title,
      r.review_content,
      r.image_url,
      r.rating,
      r.view_count,
      r.review_date,
      r.is_deleted,
      r.created_at,
      r.created_by,
      p.product_name,
      SUBSTR(r.review_content, 1, 100) AS summary,
      ROW_NUMBER() OVER (ORDER BY r.product_id, r.review_date DESC, r.id DESC) rn
    FROM review r
    LEFT JOIN product p ON r.product_id = p.id
    WHERE r.product_id = #{productId}
  )
  WHERE rn &gt; (#{cri.pageNum} - 1) * #{cri.amount}
    AND rn &lt;= #{cri.pageNum} * #{cri.amount}
</select>

<select id="getDistinctProductCount" resultType="int">
  SELECT COUNT(DISTINCT r.product_id)
  FROM review r
  JOIN product p ON p.id = r.product_id
  WHERE 1=1
    <if test="cri.keyword != null and cri.keyword != '' and cri.typeArr != null and cri.typeArr.length > 0">
      AND p.product_name LIKE '%' || #{cri.keyword} || '%'
    </if>
</select>

<select id="getTotalReviewCount" resultType="int">
  SELECT COUNT(*) FROM review WHERE product_id = #{productId}
</select>

<!-- 하드(영구) 삭제 -->
<delete id="harddel">
	DELETE FROM review WHERE id = #{id}
</delete>

<!-- 소프트 삭제 -->
<update id="softdel">
	UPDATE review
	SET is_deleted = 1
	WHERE id = #{id}
</update>

<!-- 복구 -->
<update id="restore">
	UPDATE review
	SET is_deleted = 0
	WHERE id = #{id}
</update>

</mapper>

