<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.myrium.mapper.AdminProductMapper">

  <resultMap id="productMap" type="com.myrium.domain.ProductVO">
    <id property="id" column="id" />
    <result property="product_name" column="product_name"/>
    <result property="product_content" column="product_content"/>
    <result property="product_stock" column="product_stock"/>
    <result property="product_price" column="product_price"/>
    <result property="is_deleted" column="is_deleted"/>
    <result property="is_timesales" column="is_timesales"/>
    <result property="is_mainone" column="is_mainone"/>
    <result property="is_maintwo" column="is_maintwo"/>
    <result property="is_discount" column="is_discount"/>
    <result property="discount_rate" column="discount_rate"/>
    <result property="timesalediscount_rate" column="timesalediscount_rate"/>
    <result property="total_discountrate" column="total_discountrate"/>
    <result property="discount_price" column="discount_price"/>
    <result property="sales_count" column="sales_count"/>
    <result property="created_at" column="created_at"/>
    <result property="created_by" column="created_by"/>
    <result property="updated_at" column="updated_at"/>
    <result property="updated_by" column="updated_by"/>
  </resultMap>

  <resultMap id="attachMap" type="com.myrium.domain.AttachFileDTO">
    <id property="id" column="id"/>
    <result property="user_id" column="user_id"/>
    <result property="product_id" column="product_id"/>
    <result property="file_name" column="file_name"/>
    <result property="upload_path" column="upload_path"/>
    <result property="uuid" column="uuid"/>
    <result property="image" column="image"/>
    <result property="customer_id" column="customer_id"/>
    <result property="upload_date" column="upload_date"/>
    <result property="created_at" column="created_at"/>
    <result property="created_by" column="created_by"/>
    <result property="updated_at" column="updated_at"/>
    <result property="updated_by" column="updated_by"/>
  </resultMap>

  <select id="getList" resultMap="productMap">
    SELECT * FROM product
    WHERE id > 0
    ORDER BY id DESC
  </select>
  
  <select id="getCategory" resultMap="productMap">
    SELECT * FROM category
    WHERE product_id > 0
    ORDER BY product_id DESC
  </select>

  <insert id="insert">
    INSERT INTO product (
      id, product_name, product_content, product_stock, product_price,
      is_deleted, is_timesales, is_mainone, is_maintwo, is_discount,
      discount_rate, timesalediscount_rate, total_discountrate, discount_price, sales_count,
      created_at, created_by
    ) VALUES (
      product_seq.NEXTVAL, #{product_name}, #{product_content}, #{product_stock}, #{product_price},
      #{is_deleted}, #{is_timesales}, #{is_mainone}, #{is_maintwo}, #{is_discount},
      #{discount_rate}, #{timesalediscount_rate}, #{total_discountrate}, #{discount_price}, #{sales_count},
      #{created_at}, #{created_by}
    )
  </insert>

  <insert id="insertSelectKey">
    <selectKey keyProperty="id" order="BEFORE" resultType="long">
      SELECT product_seq.NEXTVAL FROM dual
    </selectKey>
    INSERT INTO product (
      id, product_name, product_content, product_stock, product_price,
      is_deleted, is_timesales, is_mainone, is_maintwo, is_discount,
      discount_rate, timesalediscount_rate, total_discountrate, discount_price, sales_count,
      created_at, created_by
    ) VALUES (
      #{id}, #{product_name}, #{product_content}, #{product_stock}, #{product_price},
      #{is_deleted}, #{is_timesales}, #{is_mainone}, #{is_maintwo}, #{is_discount},
      #{discount_rate}, #{timesalediscount_rate}, #{total_discountrate}, #{discount_price}, #{sales_count},
      #{created_at}, #{created_by}
    )
  </insert>

  <select id="read" resultMap="productMap">
    SELECT * FROM product
    WHERE id = #{id}
  </select>

  <delete id="harddel">
    DELETE FROM product WHERE id = #{id}
  </delete>

  <update id="softdel">
    UPDATE product SET is_deleted = 1 WHERE id = #{id}
  </update>

  <update id="restore">
    UPDATE product SET is_deleted = 0 WHERE id = #{id}
  </update>

  <update id="update" parameterType="com.myrium.domain.ProductVO">
    UPDATE product SET
      product_name = #{product_name},
      product_content = #{product_content},
      product_stock = #{product_stock},
      product_price = #{product_price},
      is_deleted = #{is_deleted},
      is_timesales = #{is_timesales},
      is_mainone = #{is_mainone},
      is_maintwo = #{is_maintwo},
      is_discount = #{is_discount},
      discount_rate = #{discount_rate},
      timesalediscount_rate = #{timesalediscount_rate},
      total_discountrate = #{total_discountrate},
      discount_price = #{discount_price},
      sales_count = #{sales_count},
      updated_at = SYSDATE,
      updated_by = #{updated_by}
    WHERE id = #{id}
  </update>

  <sql id="criterial">
    <trim prefix="(" suffix=") AND" prefixOverrides="OR">
      <foreach item='type' collection="cri.typeArr">
        <trim prefix="OR">
          <choose>
            <when test="type == 'T'.toString()">
              title LIKE '%' || #{cri.keyword} || '%'
            </when>
            <when test="type == 'C'.toString()">
              content LIKE '%' || #{cri.keyword} || '%'
            </when>
            <when test="type == 'W'.toString()">
              customer_id LIKE '%' || #{cri.keyword} || '%'
            </when>
          </choose>
        </trim>
      </foreach>
    </trim>
  </sql>

  <select id="getListWithPaging" resultMap="productMap">
    <![CDATA[
    SELECT * FROM (
      SELECT /*+INDEX_DESC(product pk_product) */
        ROWNUM rn, id, product_name, product_content, product_stock, product_price,
        is_deleted, is_timesales, is_mainone, is_maintwo, is_discount,
        discount_rate, timesalediscount_rate, total_discountrate, discount_price, sales_count,
        created_at, created_by, updated_at, updated_by
      FROM product
      WHERE
    ]]>
    <include refid="criterial"/>
    <![CDATA[
      ROWNUM <= #{cri.pageNum} * #{cri.amount}
    ) WHERE rn > (#{cri.pageNum} - 1) * #{cri.amount}
    ]]>
  </select>

  <select id="getTotalCount" resultType="int">
    SELECT COUNT(*) FROM product WHERE id > 0
  </select>

  <update id="updateReadCnt">
    UPDATE product SET read_cnt = read_cnt + 1 WHERE id = #{id}
  </update>

  <insert id="insertAttach" parameterType="com.myrium.domain.AttachFileDTO">
    INSERT INTO product_files (
      id, user_id, product_id, file_name, upload_path, uuid, image,
      customer_id, upload_date, created_at, created_by
    ) VALUES (
      PRODUCT_FILES_SEQ.NEXTVAL, #{user_id}, #{product_id}, #{file_name}, #{upload_path}, #{uuid}, #{image},
      #{customer_id}, SYSDATE, SYSDATE, #{created_by}
    )
  </insert>

  <select id="findByProductId" resultMap="attachMap">
    SELECT * FROM product_files WHERE product_id = #{product_id}
  </select>

  <delete id="deleteAttachByUuid" parameterType="string">
    DELETE FROM product_files WHERE uuid = #{uuid}
  </delete>

</mapper>

